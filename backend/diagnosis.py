"""backend.diagnosis
-------------------
ç»ˆæä¼˜åŒ–ç‰ˆæ€¥è¯Šæ™ºèƒ½è¯Šæ–­ç³»ç»Ÿï¼š
1. æ‰€æœ‰æ–‡æœ¬è¾“å‡ºå‡ç”±å¤§æ¨¡å‹ç”Ÿæˆï¼ˆæ— ç¡¬ç¼–ç å“åº”ï¼‰
2. åŒ»ç–—å®‰å…¨ä¼˜å…ˆè®¾è®¡ï¼ˆé«˜é£é™©åœºæ™¯ç”±LLMåŠ¨æ€ç”Ÿæˆå“åº”ï¼‰
3. å®Œæ•´çš„è¯æ®æº¯æºä¸ä¸“ä¸šè¡¨è¿°
4. å®‰å…¨é™çº§æœºåˆ¶ï¼ˆæœ€å°åŒ–ç¡¬ç¼–ç å†…å®¹ï¼‰
"""

from __future__ import annotations
import argparse
import os
import pickle
import re
from pathlib import Path
from typing import List, Tuple, Dict, Any, Optional

# ä¸Šè¿°ä¸‰è¡Œå¯¼å…¥å·²ç§»è‡³ backend.tools.vector_search
from .llm import ArkLLM
from .config import ARK_API_KEY, EMBED_MODEL_DIR
from volcenginesdkarkruntime._exceptions import ArkError, ArkPermissionDeniedError
from .tools.vector_search import search_cases  # è¿ç§»åè·¯å¾„

# å‘é‡è·¯å¾„ä¸ç¼“å­˜é€»è¾‘å·²è¿ç§»è‡³ backend.tools.vector_search

# =============== åµŒå…¥æ¨¡å‹ ===============

# åˆ é™¤æ—§ç‰ˆ _load_embed_model/_load_vector_dbï¼Œå®Œå…¨ä½¿ç”¨ backend.tools.vector_search

# =============== å‘é‡æ•°æ®åº“ ===============

# åˆ é™¤æ—§ç‰ˆ _load_embed_model/_load_vector_dbï¼Œå®Œå…¨ä½¿ç”¨ backend.tools.vector_search


# æ—§ç‰ˆå‘é‡æ£€ç´¢æ¥å£å·²è¿ç§»è‡³ backend.tools.vector_search
def _legacy_search_cases(query: str, top_k: int = 3):
    """(Deprecated) å…¼å®¹æ—§è°ƒç”¨ï¼Œå†…éƒ¨ç›´æ¥è°ƒç”¨æ–°å®ç°"""
    return search_cases(query, top_k)

# =============== åŒ»ç–—å®‰å…¨æ ¸å¿ƒæ¨¡å— ===============

def _is_high_risk_query(query: str) -> Tuple[bool, str]:
    """æ£€æµ‹é«˜é£é™©ä¸»è¯‰ï¼ˆéœ€ç«‹å³å¹²é¢„ï¼‰"""
    high_risk_patterns = [
        (r"(èƒ¸(ç—›|é—·|æ¢—)|å¿ƒç»ç—›|å¿ƒæ¢—)", "å¿ƒè¡€ç®¡å±è±¡"),
        (r"(å‘¼å¸(å›°éš¾|æ€¥ä¿ƒ)|çª’æ¯|æ°”ä¿ƒ)", "å‘¼å¸è¡°ç«­"),
        (r"(å¤§å‡º(è¡€|è¡€))", "å¤±è¡€æ€§ä¼‘å…‹"),
        (r"(æ„è¯†(ä¸§å¤±|æ¨¡ç³Š)|æ™•å¥|æ˜è¿·)", "æ„è¯†éšœç¢"),
        (r"(è‡ª(æ€|æ®‹)|è½»ç”Ÿ)", "å¿ƒç†å±æœº"),
        (r"(å­•å¦‡|å¦Šå¨ |æ€€å­•).*?ç–¼ç—›", "å¦Šå¨ æœŸç–¼ç—›"),
        (r"(é¢ˆéƒ¨|è„ŠæŸ±).*?æŸä¼¤", "è„Šé«“æŸä¼¤é£é™©")
    ]
    
    for pattern, risk_type in high_risk_patterns:
        if re.search(pattern, query):
            return True, risk_type
    
    return False, ""

def _build_high_risk_prompt(query: str, risk_type: str, context: List[Tuple[float, dict]]) -> str:
    """æ„å»ºé«˜é£é™©åœºæ™¯çš„LLMæç¤ºè¯ï¼ˆæ‰€æœ‰å“åº”å‡ç”±LLMç”Ÿæˆï¼‰"""
    retrieved = _format_retrieved_cases(context)
    
    return f"""
### åŒ»ç–—AIç³»ç»ŸæŒ‡ä»¤ï¼ˆé«˜é£é™©åœºæ™¯ï¼‰
æ‚¨æ˜¯ä¸€åæ€¥è¯Šç§‘ä¸»ä»»åŒ»å¸ˆï¼Œæ­£åœ¨å¤„ç†ä¸€ä¸ªé«˜é£é™©æ€¥è¯Šåœºæ™¯ã€‚ç³»ç»Ÿæ£€æµ‹åˆ°æ‚£è€…ä¸»è¯‰å¯èƒ½æ¶‰åŠã€{risk_type}ã€‘ï¼Œéœ€è¦æ‚¨ç«‹å³ç”Ÿæˆä¸“ä¸šã€ç»“æ„åŒ–çš„ç´§æ€¥å“åº”ã€‚

### ä¸´åºŠå†³ç­–åè®®ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰
1. **ã€è¯æ®ä¼˜å…ˆã€‘** ä»…åŸºäºä¸‹æ–¹"æ£€ç´¢åˆ°çš„åŒ»å­¦è¯æ®"ä½œç­”ï¼Œç¦æ­¢è™šæ„åŒ»å­¦äº‹å®
2. **ã€ç´§æ€¥ç¨‹åº¦ã€‘** å¿…é¡»æ˜ç¡®æ ‡æ³¨ç´§æ€¥çº§åˆ«ï¼ˆ1-5çº§ï¼‰åŠç†ç”±
3. **ã€å…³é”®è¡ŒåŠ¨ã€‘** åˆ—å‡ºå¿…é¡»ç«‹å³æ‰§è¡Œçš„3é¡¹å…³é”®æ“ä½œï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰
4. **ã€ç¦å¿Œæ ¸æŸ¥ã€‘** å¿…é¡»æ£€æŸ¥å¹¶æ˜ç¡®æŒ‡å‡ºæ²»ç–—ç¦å¿Œ
5. **ã€è¯æ®æ ‡æ³¨ã€‘** æ‰€æœ‰ç»“è®ºéœ€æ ‡æ³¨è¯æ®ç­‰çº§ï¼ˆA/B/Cï¼‰

### æ‚£è€…ä¸»è¯‰
{query}

### æ£€ç´¢åˆ°çš„åŒ»å­¦è¯æ®ï¼ˆæŒ‰è¯æ®ç­‰çº§+ç›¸ä¼¼åº¦æ’åºï¼‰
{retrieved}

### è¯·ä¸¥æ ¼æŒ‰æ­¤ç»“æ„è¾“å‡ºï¼ˆMarkdownæ ¼å¼ï¼‰
#### ç´§æ€¥ç¨‹åº¦è¯„ä¼°
- **åˆ†çº§ï¼š** [1-5çº§]
- **ç†ç”±ï¼š** [åŸºäºè¯æ®çš„ç®€è¦åˆ†æ]

#### ç«‹å³è¡ŒåŠ¨æŒ‡å—
- **å¿…é¡»ç«‹å³æ‰§è¡Œï¼ˆ0-5åˆ†é’Ÿï¼‰ï¼š**
    - [æ“ä½œ1]
    - [æ“ä½œ2]
    - [æ“ä½œ3]
- **5-15åˆ†é’Ÿå†…å¿…é¡»å®Œæˆï¼š**
    - [æ“ä½œ1]
    - [æ“ä½œ2]

#### è¯Šç–—å…³é”®ç‚¹
- **å¿…é¡»æ’é™¤çš„å±æ€¥ç–¾ç—…ï¼š**
    - [ç–¾ç—…1]ï¼š[æ’é™¤æŒ‡å¾ï¼Œå¦‚"å¿ƒç”µå›¾æ­£å¸¸+è‚Œé’™è›‹ç™½é˜´æ€§"]
    - [ç–¾ç—…2]ï¼š[æ’é™¤æŒ‡å¾]
- **æ²»ç–—ç¦å¿Œï¼š**
    - [æ˜ç¡®ç¦å¿Œ]ï¼ˆä¾æ®ï¼š[evidence_level]çº§è¯æ®ï¼‰
- **å®‰å…¨æ›¿ä»£æ–¹æ¡ˆï¼š**
    - [æ›¿ä»£æ–¹æ¡ˆ]ï¼ˆä¾æ®ï¼š[evidence_level]çº§è¯æ®ï¼‰

#### ä¸“ä¸šå»ºè®®
[2-3å¥ä¸“ä¸šæ€»ç»“ï¼Œå¼ºè°ƒå…³é”®é£é™©å’Œå¤„ç†è¦ç‚¹]

> æ³¨æ„ï¼šè‹¥è¯æ®ä¸è¶³ï¼Œå¿…é¡»å†™æ˜"éœ€è¿›ä¸€æ­¥æ£€æŸ¥ç¡®è®¤"ï¼Œä¸å¯çŒœæµ‹
"""

def _build_safe_fallback_prompt(query: str, context: List[Tuple[float, dict]]) -> str:
    """æ„å»ºå®‰å…¨å›é€€æ¨¡å¼çš„æç¤ºè¯ï¼ˆæ‰€æœ‰å“åº”å‡ç”±LLMç”Ÿæˆï¼‰"""
    # å³ä½¿åœ¨å›é€€æ¨¡å¼ï¼Œæˆ‘ä»¬ä¹Ÿå°è¯•ç”¨LLMç”Ÿæˆå“åº”
    # ä½†æç¤ºè¯ä¼šè¯´æ˜å½“å‰å¤„äºç³»ç»Ÿé™çº§çŠ¶æ€
    
    retrieved = _format_retrieved_cases(context) if context else "æ— åŒ¹é…åŒ»å­¦è¯æ®"
    
    return f"""
### åŒ»ç–—AIç³»ç»ŸæŒ‡ä»¤ï¼ˆå®‰å…¨å›é€€æ¨¡å¼ï¼‰
æ‚¨æ˜¯ä¸€åæ€¥è¯Šç§‘ä¸»ä»»åŒ»å¸ˆã€‚åŒ»ç–—AIç³»ç»Ÿå½“å‰å¤„äºé™çº§çŠ¶æ€ï¼ˆä¸»æœåŠ¡ä¸å¯ç”¨ï¼‰ï¼Œä½†æ‚¨ä»éœ€è¦åŸºäºæœ‰é™çš„åŒ»å­¦è¯æ®æä¾›ä¸“ä¸šå»ºè®®ã€‚

### é‡è¦çº¦æŸ
1. **ã€ä»…åŸºäºè¯æ®ã€‘** ä¸¥æ ¼åŸºäºä¸‹æ–¹"æ£€ç´¢åˆ°çš„åŒ»å­¦è¯æ®"ä½œç­”ï¼Œç¦æ­¢è™šæ„
2. **ã€æ˜ç¡®æ ‡æ³¨ã€‘** å¿…é¡»æ³¨æ˜"ç³»ç»Ÿé™çº§æ¨¡å¼"å’Œè¯æ®ç­‰çº§
3. **ã€å®‰å…¨ä¼˜å…ˆã€‘** ä¼˜å…ˆè€ƒè™‘æœ€å®‰å…¨çš„å¤„ç†æ–¹æ¡ˆ
4. **ã€é¿å…çŒœæµ‹ã€‘** è¯æ®ä¸è¶³æ—¶æ˜ç¡®è¯´æ˜éœ€è¿›ä¸€æ­¥æ£€æŸ¥

### æ‚£è€…ä¸»è¯‰
{query}

### æ£€ç´¢åˆ°çš„åŒ»å­¦è¯æ®ï¼ˆå¯èƒ½ä¸å®Œæ•´ï¼‰
{retrieved}

### è¯·ä¸¥æ ¼æŒ‰æ­¤ç»“æ„è¾“å‡ºï¼ˆMarkdownæ ¼å¼ï¼‰
#### ç³»ç»ŸçŠ¶æ€å£°æ˜
- **å½“å‰çŠ¶æ€ï¼š** åŒ»ç–—AIç³»ç»Ÿé™çº§æ¨¡å¼
- **å“åº”å¯é æ€§ï¼š** [é«˜/ä¸­/ä½]ï¼ˆåŸºäºè¯æ®è´¨é‡ï¼‰
- **åŒ»ç”Ÿç¡®è®¤è¦æ±‚ï¼š** å¿…é¡»ç”±ä¸»æ²»åŒ»å¸ˆç°åœºç¡®è®¤æ‰€æœ‰å»ºè®®

#### è¯Šç–—å»ºè®®ï¼ˆåŸºäºç°æœ‰è¯æ®ï¼‰
- **ç´§æ€¥ç¨‹åº¦ï¼š** [1-5çº§]ï¼ˆä¾æ®ï¼š[ç®€è¦è¯´æ˜]ï¼‰
- **å¿…é¡»æ‰§è¡Œçš„æ“ä½œï¼š**
    - [æ“ä½œ1]ï¼ˆä¾æ®ï¼š[evidence_level]çº§è¯æ®ï¼‰
    - [æ“ä½œ2]ï¼ˆä¾æ®ï¼š[evidence_level]çº§è¯æ®ï¼‰
- **å…³é”®ç¦å¿Œï¼š**
    - [ç¦å¿Œäº‹é¡¹]ï¼ˆä¾æ®ï¼š[evidence_level]çº§è¯æ®ï¼‰

#### ä¸“ä¸šå»ºè®®
[2-3å¥ä¸“ä¸šæ€»ç»“ï¼Œå¼ºè°ƒç³»ç»ŸçŠ¶æ€é™åˆ¶å’Œéœ€åŒ»ç”Ÿç¡®è®¤çš„å…³é”®ç‚¹]

> æ³¨æ„ï¼šæ­¤å“åº”ç”±å¤‡ç”¨ç³»ç»Ÿç”Ÿæˆï¼Œæ‰€æœ‰åŒ»ç–—å†³ç­–å¿…é¡»ç”±ä¸“ä¸šåŒ»å¸ˆç¡®è®¤
"""

def _format_retrieved_cases(context: List[Tuple[float, dict]]) -> str:
    """å°†æ£€ç´¢ç»“æœè½¬åŒ–ä¸ºç»“æ„åŒ–åŒ»å­¦çŸ¥è¯†ï¼ˆä¸´åºŠå†³ç­–å…³é”®ç‚¹ï¼‰"""
    if not context:
        return "æ— åŒ¹é…åŒ»å­¦è¯æ®ï¼Œè¯·è¿›è¡ŒåŸºç¡€è¯„ä¼°"
    
    results = []
    for rank, (score, case) in enumerate(context, 1):
        disease = case["full_data"]["disease"]
        
        # æå–å…³é”®ä¸´åºŠå†³ç­–ç‚¹ï¼ˆæŒ‰æ€¥è¯Šä¼˜å…ˆçº§æ’åºï¼‰
        key_features = disease["key_features"][:2]
        urgency_emoji = "ğŸš¨" if disease["urgency_level"] == "ç´§æ€¥" else "âš ï¸"
        evidence_emoji = "âœ…" if disease["evidence_level"] == "A" else "ğŸŸ¡"
        
        # ç”Ÿæˆç»“æ„åŒ–æ‘˜è¦ï¼ˆç¬¦åˆä¸´åºŠæ€ç»´æµç¨‹ï¼‰
        info = (
            f"{urgency_emoji} **ã€{disease['name']}ã€‘** (ICD: {disease['icd_code']})\n"
            f"   â€¢ è¯æ®ç­‰çº§: {evidence_emoji} {disease['evidence_level']} | ç›¸ä¼¼åº¦: {score:.0%}\n"
            f"   â€¢ **å…³é”®ç‰¹å¾**: {', '.join(key_features)}\n"
        )
        
        # æ·»åŠ æ£€æŸ¥å»ºè®®ï¼ˆä»…æ˜¾ç¤ºæœ€é«˜ä¼˜å…ˆçº§ï¼‰
        if disease["recommended_tests"]:
            test = disease["recommended_tests"][0]
            # è§£ææ£€æŸ¥åç§°ï¼ˆå…¼å®¹æ— "|"åˆ†éš”çš„å†™æ³•ï¼‰
            if "test_name" in test and isinstance(test["test_name"], str):
                parts = test["test_name"].split("|", 1)
                test_display = parts[1].strip() if len(parts) > 1 else test["test_name"].strip()
            else:
                test_display = "æ£€æŸ¥é¡¹ç›®æœªå‘½å"
            info += f"   â€¢ **é¦–é€‰æ£€æŸ¥**: {test_display} (ç”¨äº{test.get('purpose', 'è¯Šæ–­')})\n"
        
        # æ·»åŠ æ²»ç–—æ ¸å¿ƒç‚¹ï¼ˆå¼ºè°ƒç¦å¿Œï¼‰
        if disease["treatments"]:
            treatment = disease["treatments"][0]
            desc = treatment["description"]
            # æ£€æµ‹ç¦å¿Œå…³é”®è¯
            has_contraindication = "ç¦å¿Œ" in desc or "ç¦ç”¨" in desc or "ä¸æ¨è" in desc
            info += f"   â€¢ **{'âš ï¸ é¦–é€‰æ²»ç–—' if has_contraindication else 'âœ… é¦–é€‰æ²»ç–—'}**: {treatment['intervention']}\n"
            info += f"     - {desc[:100]}{'...' if len(desc) > 100 else ''}\n"
        
        results.append(f"{rank}. {info}")
    
    return "\n".join(results)

def _build_clinical_prompt(query: str, retrieved: str) -> str:
    """æ„å»ºä¸´åºŠå†³ç­–æç¤ºè¯ï¼ˆè¯æ®é©±åŠ¨+å®‰å…¨ä¼˜å…ˆï¼‰"""
    return f"""
### ä¸´åºŠå†³ç­–åè®®ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰
1. **ã€è¯æ®ä¼˜å…ˆã€‘** ä»…åŸºäºä¸‹æ–¹"æ£€ç´¢åˆ°çš„åŒ»å­¦è¯æ®"ä½œç­”ï¼Œç¦æ­¢è™šæ„åŒ»å­¦äº‹å®
2. **ã€å±æ€¥é‰´åˆ«ã€‘** å½“ç—‡çŠ¶åŒ¹é…å¤šä¸ªå±æ€¥ç–¾ç—…æ—¶ï¼Œå¿…é¡»åˆ—å‡ºTop2é‰´åˆ«è¯Šæ–­åŠåŒºåˆ†ç‚¹
3. **ã€ç¦å¿Œæ ¸æŸ¥ã€‘** å¿…é¡»æ£€æŸ¥æ²»ç–—ç¦å¿Œï¼ˆå¦‚ï¼šééª¨æŠ˜æ€§ç–¼ç—›ç¦ç”¨é˜¿ç‰‡ç±»ï¼‰
4. **ã€è¯æ®æ ‡æ³¨ã€‘** æ‰€æœ‰ç»“è®ºéœ€æ ‡æ³¨è¯æ®ç­‰çº§ï¼ˆA/B/Cï¼‰
5. **ã€é«˜é£é™©æ‹¦æˆªã€‘** è‹¥ä¸»è¯‰å«èƒ¸ç—›/å‘¼å¸å›°éš¾ç­‰ï¼Œç«‹å³è§¦å‘ç´§æ€¥åè®®

### æ‚£è€…ä¸»è¯‰
{query}

### æ£€ç´¢åˆ°çš„åŒ»å­¦è¯æ®ï¼ˆæŒ‰è¯æ®ç­‰çº§+ç›¸ä¼¼åº¦æ’åºï¼‰
{retrieved}

### è¯·ä¸¥æ ¼æŒ‰æ­¤ç»“æ„è¾“å‡ºï¼ˆMarkdownæ ¼å¼ï¼‰

#### ç´§æ€¥ç¨‹åº¦åˆ†çº§
- **åˆ†çº§ï¼š** [1-5çº§] 
- **ç†ç”±ï¼š** [å¼•ç”¨è¯æ®ä¸­çš„urgency_level/key_features]
- **å±æ€¥é‰´åˆ«ï¼š** 
    - [ç–¾ç—…1]ï¼š[å…³é”®åŒºåˆ†ç‚¹ï¼Œå¦‚"å¿ƒç”µå›¾STæ®µæŠ¬é«˜"]
    - [ç–¾ç—…2]ï¼š[å…³é”®åŒºåˆ†ç‚¹]

#### è¯Šç–—è·¯å¾„
- **å¿…é¡»æ’é™¤çš„å±æ€¥ç–¾ç—…ï¼š** 
    - [ç–¾ç—…]ï¼š[æ’é™¤æŒ‡å¾ï¼Œå¦‚"å¿ƒç”µå›¾æ­£å¸¸+è‚Œé’™è›‹ç™½é˜´æ€§"]
- **é¦–é€‰æ£€æŸ¥ï¼š** 
    - [æ£€æŸ¥é¡¹ç›®]ï¼ˆä¾æ®ï¼š[evidence_level]çº§è¯æ®ï¼‰
    - [æ£€æŸ¥é¡¹ç›®]ï¼ˆä¾æ®ï¼š[evidence_level]çº§è¯æ®ï¼‰
- **æ²»ç–—ç¦å¿Œï¼š** 
    - [æ˜ç¡®ç¦å¿Œ]ï¼ˆä¾æ®ï¼š[evidence_level]çº§è¯æ®ï¼‰
- **åˆæ­¥å¤„ç†ï¼š** 
    - [åŸºäºAçº§è¯æ®çš„æ–¹æ¡ˆ]
    - [å®‰å…¨æ›¿ä»£æ–¹æ¡ˆï¼ˆå¦‚ç¦å¿Œå­˜åœ¨ï¼‰]

#### åŒ»ç”Ÿè¡ŒåŠ¨å»ºè®®
- **ç«‹å³æ‰§è¡Œï¼š** [2-3é¡¹å…³é”®æ“ä½œ]
- **30åˆ†é’Ÿå†…ï¼š** [å¿…é¡»å®Œæˆçš„æ£€æŸ¥/å¤„ç†]
- **éœ€ä¼šè¯Šç§‘å®¤ï¼š** [åˆ—å‡º1-2ä¸ª]

#### ä¸“ä¸šæ€»ç»“
[2-3å¥ä¸“ä¸šæ€»ç»“ï¼Œå¼ºè°ƒå…³é”®é£é™©å’Œå¤„ç†è¦ç‚¹]

> æ³¨æ„ï¼šè‹¥è¯æ®ä¸è¶³ï¼Œå¿…é¡»å†™æ˜"éœ€è¿›ä¸€æ­¥æ£€æŸ¥ç¡®è®¤"ï¼Œä¸å¯çŒœæµ‹
"""

def _call_llm_with_fallback(prompt: str, fallback_prompt: str = None, history: List[dict] = None) -> str:
    """è°ƒç”¨LLMï¼Œå¸¦æ™ºèƒ½å›é€€æœºåˆ¶"""
    try:
        llm = ArkLLM(api_key=ARK_API_KEY)
        return llm.invoke(prompt, history=history)
    except (ArkError, ArkPermissionDeniedError, Exception) as e:
        print(f"ğŸ”¥ ArkLLM ä¸»è°ƒç”¨å¤±è´¥: {str(e)}")
        
        # å¦‚æœæœ‰å¤‡ç”¨æç¤ºè¯ï¼Œå°è¯•ç”¨å¤‡ç”¨æç¤ºè¯è°ƒç”¨
        if fallback_prompt:
            try:
                print("ğŸ”„ å°è¯•ä½¿ç”¨å¤‡ç”¨æç¤ºè¯é‡æ–°è°ƒç”¨...")
                llm = ArkLLM(api_key=ARK_API_KEY)
                return llm.invoke(fallback_prompt, history=history)
            except Exception as e2:
                print(f"ğŸ”¥ ArkLLM å¤‡ç”¨è°ƒç”¨ä¹Ÿå¤±è´¥: {str(e2)}")
        
        # æç«¯æƒ…å†µï¼šè¿LLMéƒ½ä¸å¯ç”¨ï¼Œåªèƒ½è¿”å›æœ€ç®€ç³»ç»Ÿé”™è¯¯
        # æ³¨æ„ï¼šè¿™é‡Œåªä¿ç•™æœ€åŸºæœ¬çš„ç³»ç»Ÿé”™è¯¯ä¿¡æ¯ï¼ˆæ— æ³•é¿å…çš„ç¡¬ç¼–ç ï¼‰
        return (
            "âš ï¸ **ã€ç³»ç»Ÿä¸¥é‡é”™è¯¯ã€‘** åŒ»ç–—AIæœåŠ¡å®Œå…¨ä¸å¯ç”¨\n\n"
            "å½“å‰ç³»ç»ŸçŠ¶æ€ï¼š\n"
            "- ä¸»AIæœåŠ¡ä¸å¯ç”¨\n"
            "- å¤‡ç”¨æœåŠ¡ä¸å¯ç”¨\n"
            "- æ— æ³•æä¾›ä»»ä½•åŒ»ç–—å»ºè®®\n\n"
            "**è¯·ç«‹å³è”ç³»ç³»ç»Ÿç®¡ç†å‘˜å¹¶è¿›è¡Œäººå·¥è¯„ä¼°**\n"
            "æ‰€æœ‰åŒ»ç–—å†³ç­–å¿…é¡»ç”±ä¸“ä¸šåŒ»å¸ˆç°åœºç¡®è®¤"
        )

def _call_llm(query: str, context: List[Tuple[float, dict]], history: List[dict] = None) -> str:
    """è°ƒç”¨LLMç”Ÿæˆè¯Šç–—å»ºè®®ï¼ˆæ‰€æœ‰è¾“å‡ºå‡ç”±å¤§æ¨¡å‹ç”Ÿæˆï¼‰"""
    # æ„å»ºå¯¹è¯å†å²
    messages = []
    if history:
        for msg in history:
            messages.append({"role": msg["role"], "content": msg["content"]})
    
    # [1] é«˜é£é™©ä¸»è¯‰å¤„ç† - é€šè¿‡LLMç”Ÿæˆå“åº”
    is_high_risk, risk_type = _is_high_risk_query(query)
    if is_high_risk:
        print(f"ğŸš¨ æ£€æµ‹åˆ°é«˜é£é™©ä¸»è¯‰: {risk_type}")
        prompt = _build_high_risk_prompt(query, risk_type, context)
        return _call_llm_with_fallback(prompt, history=messages)
    
    # [2] æ£€æŸ¥ç©ºæŸ¥è¯¢
    if not query.strip():
        empty_prompt = (
            "### åŒ»ç–—AIç³»ç»ŸæŒ‡ä»¤\n"
            "ç”¨æˆ·æ²¡æœ‰æä¾›æœ‰æ•ˆçš„æ‚£è€…ä¸»è¯‰ã€‚è¯·ç”Ÿæˆä¸€ä¸ªä¸“ä¸šã€å‹å¥½çš„æç¤ºï¼ŒæŒ‡å¯¼ç”¨æˆ·å¦‚ä½•æ­£ç¡®æè¿°ç—‡çŠ¶ã€‚\n\n"
            "### è¦æ±‚\n"
            "1. ç”¨ä¸­æ–‡å›ç­”\n"
            "2. ä¿æŒä¸“ä¸šä½†å‹å¥½çš„è¯­æ°”\n"
            "3. æä¾›2-3ä¸ªä¸»è¯‰æè¿°çš„ç¤ºä¾‹\n"
            "4. ä¸è¦æŒ‡è´£ç”¨æˆ·ï¼Œè€Œæ˜¯æä¾›å»ºè®¾æ€§æŒ‡å¯¼"
        )
        return _call_llm_with_fallback(empty_prompt)
    
    # [3] å¸¸è§„æŸ¥è¯¢å¤„ç†
    retrieved = _format_retrieved_cases(context)
    prompt = _build_clinical_prompt(query, retrieved)
    fallback_prompt = _build_safe_fallback_prompt(query, context)
    
    response = _call_llm_with_fallback(prompt, fallback_prompt, history=messages)
    
    # [4] è¯æ®æº¯æºï¼ˆå¼ºåˆ¶æ·»åŠ æ¥æºï¼Œä½†é€šè¿‡LLMç”Ÿæˆï¼‰
    if context and "ç³»ç»Ÿä¸¥é‡é”™è¯¯" not in response:
        source_prompt = (
            f"### åŒ»ç–—AIç³»ç»ŸæŒ‡ä»¤\n"
            f"è¯·ä¸ºä»¥ä¸‹è¯Šç–—å»ºè®®æ·»åŠ è¯æ®æ¥æºè¯´æ˜ã€‚åªæ·»åŠ æ¥æºä¿¡æ¯ï¼Œä¸è¦ä¿®æ”¹åŸæœ‰å†…å®¹ã€‚\n\n"
            f"### åŸå§‹è¯Šç–—å»ºè®®\n"
            f"{response}\n\n"
            f"### åŒ»å­¦è¯æ®æ¥æº\n"
            f"ä¾æ®ï¼š{context[0][1]['full_data']['disease']['source']} | è¯æ®ç­‰çº§ï¼š{context[0][1]['full_data']['disease']['evidence_level']}\n\n"
            f"### è¦æ±‚\n"
            f"1. åœ¨åŸå§‹å»ºè®®æœ«å°¾æ·»åŠ æ¥æºä¿¡æ¯\n"
            f"2. ä½¿ç”¨ä¸“ä¸šä½†ä¸çªå…€çš„æ–¹å¼\n"
            f"3. ä¿æŒMarkdownæ ¼å¼"
        )
        return _call_llm_with_fallback(source_prompt)
    
    return response

# =============== å¯¹å¤–æ¥å£ ===============

def get_diagnosis(query: str, history: List[dict] = None, top_k: int = 3) -> str:
    """è·å–ç»“æ„åŒ–è¯Šç–—å»ºè®®ï¼ˆæ‰€æœ‰è¾“å‡ºå‡ç”±å¤§æ¨¡å‹ç”Ÿæˆï¼‰"""
    print(f"ğŸ” æ­£åœ¨åˆ†æä¸»è¯‰: '{query}'")
    
    # æ£€ç´¢åŒ»å­¦çŸ¥è¯†
    cases = search_cases(query, top_k)
    print(f"ğŸ“Š åŒ¹é…åˆ° {len(cases)} æ¡åŒ»å­¦è¯æ®")

    # ç”Ÿæˆè¯Šç–—å»ºè®®ï¼ˆæ‰€æœ‰è¾“å‡ºå‡ç”±LLMç”Ÿæˆï¼‰
    return _call_llm(query, cases, history)

# =============== CLI ===============

def _build_cli_error_prompt(error_msg: str) -> str:
    """æ„å»ºCLIé”™è¯¯æ¶ˆæ¯çš„LLMæç¤ºè¯"""
    return (
        f"### åŒ»ç–—AIç³»ç»ŸæŒ‡ä»¤\n"
        f"ç”¨æˆ·åœ¨ä½¿ç”¨å‘½ä»¤è¡Œç•Œé¢æ—¶é‡åˆ°äº†é”™è¯¯ã€‚è¯·ç”Ÿæˆä¸€ä¸ªä¸“ä¸šã€æ¸…æ™°çš„é”™è¯¯è¯´æ˜å’Œè§£å†³æ–¹æ¡ˆã€‚\n\n"
        f"### é”™è¯¯ä¿¡æ¯\n"
        f"{error_msg}\n\n"
        f"### è¦æ±‚\n"
        f"1. ç”¨ä¸­æ–‡å›ç­”\n"
        f"2. è§£é‡Šé”™è¯¯åŸå› ï¼ˆæŠ€æœ¯å±‚é¢å’Œç”¨æˆ·æ“ä½œå±‚é¢ï¼‰\n"
        f"3. æä¾›2-3ä¸ªå…·ä½“è§£å†³æ–¹æ¡ˆ\n"
        f"4. ä¿æŒä¸“ä¸šä½†å‹å¥½çš„è¯­æ°”\n"
        f"5. ä¸è¦åŒ…å«æŠ€æœ¯æœ¯è¯­ï¼Œé¢å‘åŒ»ç–—ä¸“ä¸šäººå‘˜è§£é‡Š"
    )

def _cli() -> None:
    """å‘½ä»¤è¡Œæ¥å£ï¼ˆæ‰€æœ‰è¾“å‡ºå‡ç”±å¤§æ¨¡å‹ç”Ÿæˆï¼‰"""
    try:
        parser = argparse.ArgumentParser(
            description="æ€¥è¯Šæ™ºèƒ½è¯Šæ–­ç³»ç»Ÿ - è¯æ®é©±åŠ¨çš„ä¸´åºŠå†³ç­–æ”¯æŒ",
            formatter_class=argparse.RawTextHelpFormatter,
        )
        parser.add_argument(
            "query",
            help="æ‚£è€…ä¸»è¯‰/ç—‡çŠ¶æè¿°ï¼ˆä¾‹: '60å²ç”·æ€§çªå‘èƒ¸ç—›30åˆ†é’Ÿ'ï¼‰",
        )
        parser.add_argument("--top_k", type=int, default=3, help="è¿”å›åŒ»å­¦è¯æ®æ•°é‡ (é»˜è®¤: 3)")
        parser.add_argument("--debug", action="store_true", help="æ˜¾ç¤ºè¯¦ç»†æ£€ç´¢ç»“æœ")
        args = parser.parse_args()

        # æ‰§è¡Œè¯Šæ–­
        print("\nğŸ”„ æ­£åœ¨è¿›è¡Œä¸´åºŠå†³ç­–åˆ†æ...")
        answer = get_diagnosis(args.query, top_k=args.top_k)

        # é€šè¿‡LLMç”Ÿæˆæ ‡é¢˜ï¼ˆç¡®ä¿ä¸€è‡´æ€§ï¼‰
        header_prompt = (
            "### åŒ»ç–—AIç³»ç»ŸæŒ‡ä»¤\n"
            "è¯·ä¸ºä»¥ä¸‹æ€¥è¯Šä¸´åºŠå†³ç­–å»ºè®®ç”Ÿæˆä¸€ä¸ªä¸“ä¸šã€ç®€æ´çš„æ ‡é¢˜ã€‚\n\n"
            "### è¯Šç–—å»ºè®®å†…å®¹\n"
            f"{answer[:500]}...\n\n"  # åªæä¾›éƒ¨åˆ†å†…å®¹ä¾›å‚è€ƒ
            "### è¦æ±‚\n"
            "1. æ ‡é¢˜åº”åæ˜ æ‚£è€…ä¸»è¯‰å’Œç´§æ€¥ç¨‹åº¦\n"
            "2. åŒ…å«ç´§æ€¥ç¨‹åº¦æ ‡è¯†ï¼ˆå¦‚'ã€ç´§æ€¥ã€‘'ï¼‰\n"
            "3. é•¿åº¦ä¸è¶…è¿‡20ä¸ªå­—\n"
            "4. ä½¿ç”¨ä¸“ä¸šä½†æ˜“æ‡‚çš„åŒ»å­¦æœ¯è¯­"
        )
        header = _call_llm_with_fallback(header_prompt)

        # æ˜¾ç¤ºç»“æœ
        print("\n" + "=" * 50)
        print(f"{header.strip()}")
        print("=" * 50)
        print(answer)

        # è°ƒè¯•æ¨¡å¼æ˜¾ç¤ºæ£€ç´¢ç»“æœ
        if args.debug:
            debug_prompt = (
                "### åŒ»ç–—AIç³»ç»ŸæŒ‡ä»¤\n"
                "è¯·è§£é‡Šä»¥ä¸‹åŒ»å­¦è¯æ®å¯¹å½“å‰è¯Šæ–­çš„æ„ä¹‰ã€‚é¢å‘æ€¥è¯Šç§‘åŒ»ç”Ÿæä¾›ä¸“ä¸šè§£è¯»ã€‚\n\n"
                "### æ£€ç´¢åˆ°çš„åŒ»å­¦è¯æ®\n"
                f"{_format_retrieved_cases(search_cases(args.query, 10))}\n\n"
                "### æ‚£è€…ä¸»è¯‰\n"
                f"{args.query}\n\n"
                "### è¦æ±‚\n"
                "1. åˆ†ææ¯æ¡è¯æ®çš„ç›¸å…³æ€§å’Œå¯é æ€§\n"
                "2. æŒ‡å‡ºå“ªäº›è¯æ®å¯¹å½“å‰è¯Šæ–­æœ€å…³é”®\n"
                "3. ç”¨ä¸“ä¸šä½†ç®€æ´çš„è¯­è¨€\n"
                "4. ä¿æŒMarkdownæ ¼å¼"
            )
            debug_info = _call_llm_with_fallback(debug_prompt)

            print("\nğŸ” æ£€ç´¢è¯æ®ä¸“ä¸šè§£è¯»:")
            print(debug_info)

    except Exception as e:
        # æ‰€æœ‰é”™è¯¯æ¶ˆæ¯ä¹Ÿé€šè¿‡LLMç”Ÿæˆ
        error_msg = f"å‘½ä»¤è¡Œç•Œé¢å‘ç”Ÿé”™è¯¯: {str(e)}"
        print("\nâŒ å‘ç”Ÿç³»ç»Ÿé”™è¯¯ï¼Œæ­£åœ¨ç”Ÿæˆä¸“ä¸šé”™è¯¯è¯´æ˜...")
        error_response = _call_llm_with_fallback(_build_cli_error_prompt(error_msg))
        print("\n" + "=" * 50)
        print("âŒ ç³»ç»Ÿé”™è¯¯è¯´æ˜")
        print("=" * 50)
        print(error_response)

if __name__ == "__main__":
    _cli() 